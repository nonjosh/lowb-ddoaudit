# Ransack Timer Logic

## Overview

DDO has a **chest ransack** system that reduces loot drop rates when running the same quest repeatedly. This app tracks when ransack timers will expire.

## Game Rules (DDO Official)

### Chest Ransack Mechanic

When opening chests multiple times in the same quest:

| Chest Opening | Drop Rate |
| ------------- | --------- |
| 1st           | 100%      |
| 2nd           | 80%       |
| 3rd           | 60%       |
| 4th           | 40%       |
| 5th+          | 20%       |

### Ransack Timer Duration

- **Full Duration**: 7 days (168 hours)
- Timer starts after the most recent quest completion
- Penalty decreases by **50%** every **18 hours**

### Recovery Schedule

| Time Since Last Run | Penalty Reduction         |
| ------------------- | ------------------------- |
| 0 hours             | Full penalty              |
| 18 hours            | 50% recovered             |
| 36 hours            | 75% recovered             |
| 54 hours            | 87.5% recovered           |
| 72 hours            | 93.75% recovered          |
| ...                 | Continues logarithmically |
| ~168 hours (7 days) | Fully recovered           |

**Note**: First-time difficulty completion waives ransack penalty.

## Implementation

### Data Model

**File**: `src/storage/ransackDb.ts`

```typescript
export interface RansackTimer {
  id?: number; // Auto-generated by Dexie
  characterId: string;
  characterName: string;
  questId: string;
  questName: string;
  createdAt: string; // ISO timestamp when timer was set
  expiresAt: string; // ISO timestamp when timer expires (7 days later)
  playerName: string; // For filtering by player
}
```

### Storage Layer (IndexedDB via Dexie)

```typescript
class RansackDatabase extends Dexie {
  timers!: Table<RansackTimer>;

  constructor() {
    super("ransack-timers");
    this.version(1).stores({
      timers:
        "++id, characterId, questId, playerName, expiresAt, [characterId+questId]",
    });
  }
}

export const ransackDb = new RansackDatabase();
```

### CRUD Operations

```typescript
// Get all timers
export async function getAllRansackTimers(): Promise<RansackTimer[]>;

// Get timers for a specific player
export async function getRansackTimersByPlayer(
  playerName: string,
): Promise<RansackTimer[]>;

// Add or update a timer (upsert by characterId+questId)
export async function addRansackTimer(
  timer: Omit<RansackTimer, "id">,
): Promise<number>;

// Delete a specific timer
export async function deleteRansackTimer(id: number): Promise<void>;

// Clean up expired timers
export async function deleteExpiredTimers(): Promise<void>;

// Clear all timers
export async function clearAllRansackTimers(): Promise<void>;
```

### Context Layer

**File**: `src/contexts/RansackContext.tsx`

```typescript
export interface RansackContextValue {
  timers: RansackTimer[];
  timersByPlayer: Record<string, RansackTimer[]>;
  loading: boolean;
  addTimer: (timer: Omit<RansackTimer, "id">) => Promise<void>;
  deleteTimer: (id: number) => Promise<void>;
  refreshTimers: () => Promise<void>;
  getTimersForPlayer: (playerName: string) => RansackTimer[];
}
```

Features:

- Auto-refresh every 60 seconds
- Auto-delete expired timers on refresh
- Grouped by player name

### Default Timer Configuration

When adding a new timer:

- **Duration**: 168 hours (7 days)
- **Default expiry**: `now + 168 hours`
- **Character**: First online character or first in list
- **Quest**: Active quest from LFM/raid activity, or empty

### Timer Display Format

**File**: `src/api/ddoAudit/helpers.ts`

```typescript
export function formatTimeRemaining(remainingMs: number): string {
  if (!Number.isFinite(remainingMs)) return "Available";
  if (remainingMs <= 0) return "Ready";

  const totalMinutes = Math.ceil(remainingMs / 60000);
  const days = Math.floor(totalMinutes / (60 * 24));
  const hours = Math.floor((totalMinutes - days * 60 * 24) / 60);
  const minutes = totalMinutes - days * 60 * 24 - hours * 60;

  if (days > 0) return `${days}d ${hours}h ${minutes}m`;
  if (hours > 0) return `${hours}h ${minutes}m`;
  return `${minutes}m`;
}
```

### UI Structure

```
PlayerCharactersDialog
├── Header: Player name + toggle [Characters | Ransack]
├── Ransack View (when selected)
│   ├── Toolbar: [Group by: Char | Quest] [+ Add Timer]
│   ├── RansackTimerTable (grouped by selection)
│   │   ├── Quest name / Character name
│   │   ├── Time remaining countdown
│   │   ├── Expiry date
│   │   └── Delete button
│   └── AddRansackTimerDialog (modal)
│       ├── Quest autocomplete
│       ├── Character dropdown
│       └── DateTime picker (default: now + 168h)
```

## Comparison: Raid Lockout vs Ransack

| Feature  | Raid Lockout     | Chest Ransack     |
| -------- | ---------------- | ----------------- |
| Duration | 66 hours         | 168 hours         |
| Affects  | Raid credit/loot | Chest drop rates  |
| Source   | DDO Audit API    | User-entered      |
| Recovery | Full after timer | Gradual (50%/18h) |
| Tracked  | Automatically    | Manually          |

## Related Files

| File                                                                     | Purpose                    |
| ------------------------------------------------------------------------ | -------------------------- |
| [src/storage/ransackDb.ts](../../src/storage/ransackDb.ts)               | IndexedDB storage          |
| [src/contexts/RansackContext.tsx](../../src/contexts/RansackContext.tsx) | React context provider     |
| [src/contexts/useRansack.ts](../../src/contexts/useRansack.ts)           | Hook for accessing context |

## Changelog

| Date    | Change                        | Reason                     |
| ------- | ----------------------------- | -------------------------- |
| 2024-04 | Initial ransack timer feature | Track chest ransack timers |
